<!DOCTYPE html>
<html>
  <head>
    <title>Simpleplayer Simple Game test</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <script src="../../../packages/browser/dist/release/bundle.js"></script>

    <script>
      // Define geographic extent: CRS, min/max X, min/max Y
      const extent = new udvizBrowser.itowns.Extent(
        'EPSG:4326',
        1837816.94334,
        1847692.32501,
        5170036.4587,
        5178412.82698
      );

      const frame3DPlanar = new udvizBrowser.Frame3DPlanar(extent, {
        hasItownsControls: true
      });

      const GameContextScript = class extends udvizBrowser.Shared.Game
        .ScriptBase {
        init() {
          console.log('hello from game context');

          this.goCubes = [];
          this.pause = false;
          setInterval(() => {
            if (this.pause) return;
            const newGOCube = new udvizBrowser.Shared.Game.Object3D({
              components: {
                Render: {
                  idRenderData: 'cube',
                  color: [Math.random(), Math.random(), Math.random(), 1]
                }
              }
            });

            const size = Math.random() * 200 + 50;
            newGOCube.scale.set(size, size, size);
            this.goCubes.push(newGOCube);
            this.context.addObject3D(newGOCube);
          }, 3000);
        }

        onCommand(type) {
          if (type === 'toggle_pause') this.pause = !this.pause;
        }

        tick() {
          if (this.pause) return;

          for (let index = this.goCubes.length - 1; index >= 0; index--) {
            const cube = this.goCubes[index];
            cube.position.z += 0.1 * this.context.dt;
            cube.setOutdated(true); // notify game external context that this gameobject need update

            // sky is the limit
            if (cube.position.z > 2000) {
              this.context.removeObject3D(cube.uuid);
              this.goCubes.splice(index, 1);
            }
          }
        }
        static get ID_SCRIPT() {
          return 'game_context_script';
        }
      };

      const GameExternalContextScript = class extends udvizBrowser.Game.External
        .ScriptBase {
        init() {
          console.log('hello from game external context ');

          this.context.inputManager.addMouseCommand(
            'command_id',
            'click',
            () => {
              return new udvizBrowser.Shared.Command({
                type: 'toggle_pause'
              });
            }
          );
        }
        static get ID_SCRIPT() {
          return 'game_external_context_script';
        }
      };

      const gameObject3D = new udvizBrowser.Shared.Game.Object3D({
        static: true,
        components: {
          GameScript: {
            idScripts: [GameContextScript.ID_SCRIPT]
          },
          ExternalScript: {
            idScripts: [GameExternalContextScript.ID_SCRIPT]
          }
        }
      });

      const game = new udvizBrowser.Game.External.SinglePlanarProcess(
        gameObject3D,
        frame3DPlanar,
        new udvizBrowser.AssetManager(),
        new udvizBrowser.InputManager(),
        {
          gameScriptClass: [GameContextScript],
          externalGameScriptClass: [GameExternalContextScript],
          gameOrigin: { x: extent.center().x, y: extent.center().y, z: 100 }
        }
      );

      game.start();
    </script>
  </body>
</html>
