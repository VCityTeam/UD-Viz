<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link type="text/css" rel="stylesheet" href="custom.css"><title>Source: THREEUtil.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/utils_browser</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="RequestAnimationFrameProcess_RequestAnimationFrameProcess.html">RequestAnimationFrameProcess</a></div><div class="sidebar-section-children"><a href="Vector2Input.html">Vector2Input</a></div><div class="sidebar-section-children"><a href="Vector3Input.html">Vector3Input</a></div><div class="sidebar-section-children"><a href="Vector4Input.html">Vector4Input</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributing.html">Contributing</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Definitions.html">Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-ReleasePublish.html">ReleasePublish</a></div><div class="sidebar-section-children"><a href="tutorial-Reproducibility.html">Reproducibility</a></div><div class="sidebar-section-children"><a href="tutorial-architecture.html">architecture</a></div><div class="sidebar-section-children"><a href="tutorial-game.html">game</a></div><div class="sidebar-section-children"><a href="tutorial-how_to_import.html">how_to_import</a></div><div class="sidebar-section-children"><a href="tutorial-initial_camera_transform.html">initial_camera_transform</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#FileReaderCallback">FileReaderCallback</a></div><div class="sidebar-section-children"><a href="global.html#RequestService">RequestService</a></div><div class="sidebar-section-children"><a href="global.html#SceneConfig">SceneConfig</a></div><div class="sidebar-section-children"><a href="global.html#SpriteStringOptions">SpriteStringOptions</a></div><div class="sidebar-section-children"><a href="global.html#URLSetCameraMatrix">URLSetCameraMatrix</a></div><div class="sidebar-section-children"><a href="global.html#addCubeTexture">addCubeTexture</a></div><div class="sidebar-section-children"><a href="global.html#addLights">addLights</a></div><div class="sidebar-section-children"><a href="global.html#appendCameraMatrixToURL">appendCameraMatrixToURL</a></div><div class="sidebar-section-children"><a href="global.html#appendWireframeByGeometryAttributeToObject3D">appendWireframeByGeometryAttributeToObject3D</a></div><div class="sidebar-section-children"><a href="global.html#appendWireframeToObject3D">appendWireframeToObject3D</a></div><div class="sidebar-section-children"><a href="global.html#autoDurationTravel">autoDurationTravel</a></div><div class="sidebar-section-children"><a href="global.html#bindLightTransform">bindLightTransform</a></div><div class="sidebar-section-children"><a href="global.html#cameraFitRectangle">cameraFitRectangle</a></div><div class="sidebar-section-children"><a href="global.html#cbTickAnimationFrame">cbTickAnimationFrame</a></div><div class="sidebar-section-children"><a href="global.html#checkParentChild">checkParentChild</a></div><div class="sidebar-section-children"><a href="global.html#colorSpace">colorSpace</a></div><div class="sidebar-section-children"><a href="global.html#computeFileNameFromPath">computeFileNameFromPath</a></div><div class="sidebar-section-children"><a href="global.html#computeNearFarCamera">computeNearFarCamera</a></div><div class="sidebar-section-children"><a href="global.html#createDateIntervalInput">createDateIntervalInput</a></div><div class="sidebar-section-children"><a href="global.html#createDisplayable">createDisplayable</a></div><div class="sidebar-section-children"><a href="global.html#createLabelInput">createLabelInput</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageCheckbox">createLocalStorageCheckbox</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageDetails">createLocalStorageDetails</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageNumberInput">createLocalStorageNumberInput</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageSlider">createLocalStorageSlider</a></div><div class="sidebar-section-children"><a href="global.html#createSpriteFromString">createSpriteFromString</a></div><div class="sidebar-section-children"><a href="global.html#defaultConfigScene">defaultConfigScene</a></div><div class="sidebar-section-children"><a href="global.html#downloadImageOnDisk">downloadImageOnDisk</a></div><div class="sidebar-section-children"><a href="global.html#downloadObjectAsJson">downloadObjectAsJson</a></div><div class="sidebar-section-children"><a href="global.html#fetchC3DTileFeatureWithNodeText">fetchC3DTileFeatureWithNodeText</a></div><div class="sidebar-section-children"><a href="global.html#focusC3DTilesLayer">focusC3DTilesLayer</a></div><div class="sidebar-section-children"><a href="global.html#focusCameraOn">focusCameraOn</a></div><div class="sidebar-section-children"><a href="global.html#getUriLocalname">getUriLocalname</a></div><div class="sidebar-section-children"><a href="global.html#getUriNamespace">getUriNamespace</a></div><div class="sidebar-section-children"><a href="global.html#initRenderer">initRenderer</a></div><div class="sidebar-section-children"><a href="global.html#initScene">initScene</a></div><div class="sidebar-section-children"><a href="global.html#loadJSON">loadJSON</a></div><div class="sidebar-section-children"><a href="global.html#loadMultipleJSON">loadMultipleJSON</a></div><div class="sidebar-section-children"><a href="global.html#loadTextFile">loadTextFile</a></div><div class="sidebar-section-children"><a href="global.html#localStorageSetMatrix4">localStorageSetMatrix4</a></div><div class="sidebar-section-children"><a href="global.html#localStorageSetVector3">localStorageSetVector3</a></div><div class="sidebar-section-children"><a href="global.html#readFileAsGltf">readFileAsGltf</a></div><div class="sidebar-section-children"><a href="global.html#readSingleFileAsDataUrl">readSingleFileAsDataUrl</a></div><div class="sidebar-section-children"><a href="global.html#readSingleFileAsText">readSingleFileAsText</a></div><div class="sidebar-section-children"><a href="global.html#tokenizeURI">tokenizeURI</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="Github" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udviz/extensions_3d_tiles_temporal" href="../extensions_3d_tiles_temporal" target="">udviz/extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/frame3d" href="../frame3d" target="">udviz/frame3d</a></div><div class="navbar-item"><a id="udviz/game_browser" href="../game_browser" target="">udviz/game_browser</a></div><div class="navbar-item"><a id="udviz/game_browser_template" href="../game_browser_template" target="">udviz/game_browser_template</a></div><div class="navbar-item"><a id="udviz/game_editor" href="../game_editor" target="">udviz/game_editor</a></div><div class="navbar-item"><a id="udviz/game_node" href="../game_node" target="">udviz/game_node</a></div><div class="navbar-item"><a id="udviz/game_node_template" href="../game_node_template" target="">udviz/game_node_template</a></div><div class="navbar-item"><a id="udviz/game_shared" href="../game_shared" target="">udviz/game_shared</a></div><div class="navbar-item"><a id="udviz/game_shared_template" href="../game_shared_template" target="">udviz/game_shared_template</a></div><div class="navbar-item"><a id="udviz/show_room" href="../show_room" target="">udviz/show_room</a></div><div class="navbar-item"><a id="udviz/smdb" href="../smdb" target="">udviz/smdb</a></div><div class="navbar-item"><a id="udviz/utils_browser" href="../utils_browser" target="">udviz/utils_browser</a></div><div class="navbar-item"><a id="udviz/utils_node" href="../utils_node" target="">udviz/utils_node</a></div><div class="navbar-item"><a id="udviz/utils_shared" href="../utils_shared" target="">udviz/utils_shared</a></div><div class="navbar-item"><a id="udviz/visualizer" href="../visualizer" target="">udviz/visualizer</a></div><div class="navbar-item"><a id="udviz/widget_3d_tiles" href="../widget_3d_tiles" target="">udviz/widget_3d_tiles</a></div><div class="navbar-item"><a id="udviz/widget_base_map" href="../widget_base_map" target="">udviz/widget_base_map</a></div><div class="navbar-item"><a id="udviz/widget_bookmark" href="../widget_bookmark" target="">udviz/widget_bookmark</a></div><div class="navbar-item"><a id="udviz/widget_camera_positioner" href="../widget_camera_positioner" target="">udviz/widget_camera_positioner</a></div><div class="navbar-item"><a id="udviz/widget_extensions_3d_tiles_temporal" href="../widget_extensions_3d_tiles_temporal" target="">udviz/widget_extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/widget_geocoding" href="../widget_geocoding" target="">udviz/widget_geocoding</a></div><div class="navbar-item"><a id="udviz/widget_guided_tour" href="../widget_guided_tour" target="">udviz/widget_guided_tour</a></div><div class="navbar-item"><a id="udviz/widget_layer_choice" href="../widget_layer_choice" target="">udviz/widget_layer_choice</a></div><div class="navbar-item"><a id="udviz/widget_legonizer" href="../widget_legonizer" target="">udviz/widget_legonizer</a></div><div class="navbar-item"><a id="udviz/widget_planar_controls" href="../widget_planar_controls" target="">udviz/widget_planar_controls</a></div><div class="navbar-item"><a id="udviz/widget_slide_show" href="../widget_slide_show" target="">udviz/widget_slide_show</a></div><div class="navbar-item"><a id="udviz/widget_sparql" href="../widget_sparql" target="">udviz/widget_sparql</a></div><div class="navbar-item"><a id="udviz/widget_versioning" href="../widget_versioning" target="">udviz/widget_versioning</a></div><div class="navbar-item"><a id="udviz/widget_workspace" href="../widget_workspace" target="">udviz/widget_workspace</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">THREEUtil.js</h1></header><article><pre class="prettyprint source lang-js"><code>const THREE = require('three');
const { objectOverWrite } = require('@ud-viz/utils_shared');

/**
 * @typedef SceneConfig
 * @property {number} cameraFov - default camera fov
 * @property {number} shadowMapSize - size of shadow map
 * @property {object} sky - sky property
 * @property {{r:number,g:number,b:number}} sky.color - rgb color (value are between [0,1])
 * @property {{offset:number,phi:number,theta:number}} sky.sun_position - position of the sun in sheprical coord (phi theta) + an offset {@link THREEUtil.bindLightTransform}
 */

/**
 * Set of function for a high level use of THREE.js
 */
/**
 *  Default scene 3D config
 *
 * @type {SceneConfig}
 */
const defaultConfigScene = {
  cameraFov: 60,
  shadowMapSize: 2046,
  sky: {
    color: {
      r: 0.4,
      g: 0.6,
      b: 0.8,
    },
    sun_position: {
      offset: 10,
      phi: 1,
      theta: 0.3,
    },
  },
};
export { defaultConfigScene };

/**
 * Init scene 3D with {@link SceneConfig}
 *
 * @param {THREE.PerspectiveCamera} camera - camera rendering scene
 * @param {THREE.WebGLRenderer} renderer - webgl renderer
 * @param {THREE.Scene} scene - scene
 * @param {SceneConfig|null} config - config
 * @param {THREE.Object3D|null} object3D - object to focus with shadow map
 * @returns {THREE.DirectionalLight} - directional light created
 */
export function initScene(camera, renderer, scene, config, object3D) {
  const configToApply = JSON.parse(JSON.stringify(defaultConfigScene));
  objectOverWrite(configToApply, config);

  camera.fov = configToApply.cameraFov;

  // Init renderer
  initRenderer(
    renderer,
    new THREE.Color(
      configToApply.sky.color.r,
      configToApply.sky.color.g,
      configToApply.sky.color.b
    )
  );

  // Add lights
  const { directionalLight } = addLights(scene);

  // Configure shadows based on a config files
  directionalLight.shadow.mapSize = new THREE.Vector2(
    configToApply.shadowMapSize,
    configToApply.shadowMapSize
  );
  directionalLight.castShadow = true;
  directionalLight.shadow.bias = -0.0005;

  if (configToApply.sky.paths) {
    addCubeTexture(configToApply.sky.paths, scene);
  }

  if (object3D) {
    bindLightTransform(
      configToApply.sky.sun_position.offset,
      configToApply.sky.sun_position.phi,
      configToApply.sky.sun_position.theta,
      object3D,
      directionalLight
    );
  }

  return directionalLight; // return the directional light
}

/**
 * Texture encoding used to have the right color of the .glb model + have an alpha channel
 */
const colorSpace = THREE.SRGBColorSpace;
export { colorSpace };

/**
 *
 * @param {Array&lt;string>} paths - paths of cube texture order should be negX posX negY posY posZ negZ
 * @param {THREE.Scene} scene - 3d scene
 */
export function addCubeTexture(paths, scene) {
  const loader = new THREE.CubeTextureLoader();
  const texture = loader.load(paths);
  scene.background = texture;
}

/**
 * Add default lights to a scene 3D
 * one directional and one ambient
 *
 * @param {THREE.Scene} scene - the scene where to add lights
 * @returns {{directionalLight:THREE.DirectionalLight, ambientLight:THREE.AmbientLight}} - lights added
 */
export function addLights(scene) {
  // Lights
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
  directionalLight.position.set(100, 100, 500);
  directionalLight.target.position.set(0, 0, 0);
  directionalLight.updateMatrixWorld();
  scene.add(directionalLight);

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
  scene.add(ambientLight);

  return { directionalLight: directionalLight, ambientLight: ambientLight };
}

/**
 * Initialize the webgl renderer with default values
 *
 * @param {THREE.WebGLRenderer} renderer - the renderer to init
 * @param {THREE.Color} skyColor - clear color of the scene
 * @param {boolean} clear - autoclear, default is false
 */
export function initRenderer(renderer, skyColor, clear = false) {
  // Set sky color to blue
  renderer.setClearColor(skyColor, 1);
  renderer.autoClear = clear;
  renderer.autoClearColor = clear;
  renderer.outputColorSpace = colorSpace;
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = true;
  // To antialias the shadow
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
}

/**
 * Place the directional light in order its shadow camera fit the object
 *
 * @param {number} offset - distance from the bounding sphere of the object to the light
 * @param {number} phi - phi of spherical coord in radian
 * @param {number} theta - theta of spherical coord in radian
 * @param {THREE.Object3D} obj - the object to fit inside the projection plane of the shadow camera
 * @param {THREE.DirectionalLight} dirLight - the light with the shadow camera
 */
export function bindLightTransform(offset, phi, theta, obj, dirLight) {
  // Computing boundingSphere
  const bb = new THREE.Box3().setFromObject(obj);
  const center = bb.getCenter(new THREE.Vector3());
  const bsphere = bb.getBoundingSphere(new THREE.Sphere(center));
  const sphericalPoint = new THREE.Spherical(
    bsphere.radius + offset,
    phi,
    theta
  );

  // Set the light's target
  dirLight.target.position.copy(center);
  dirLight.target.updateMatrixWorld();

  // Convert spherical coordinates in cartesian
  const vecLightPos = new THREE.Vector3();
  vecLightPos.setFromSpherical(sphericalPoint);
  vecLightPos.add(dirLight.target.position);

  // Place directionnal lights
  dirLight.position.copy(vecLightPos);
  dirLight.updateMatrixWorld();

  // Set up camera that computes the shadow map
  const cameraShadow = dirLight.shadow.camera;
  cameraShadow.near = offset;
  cameraShadow.far = offset + bsphere.radius * 2;
  cameraShadow.top = bsphere.radius;
  cameraShadow.right = bsphere.radius;
  cameraShadow.left = -bsphere.radius;
  cameraShadow.bottom = -bsphere.radius;
  cameraShadow.updateProjectionMatrix();
}

/**
 * Compute near and far of camera in order to wrap a box define by a min and max value
 *
 * @param {THREE.PerspectiveCamera} camera - camera to compute near and far
 * @param {THREE.Vector3} min - min coord of box
 * @param {THREE.Vector3} max - max coord of box
 */
export function computeNearFarCamera(camera, min, max) {
  const points = [
    new THREE.Vector3(min.x, min.y, min.z),
    new THREE.Vector3(min.x, min.y, max.z),
    new THREE.Vector3(min.x, max.y, min.z),
    new THREE.Vector3(min.x, max.y, max.z),
    new THREE.Vector3(max.x, min.y, min.z),
    new THREE.Vector3(max.x, min.y, max.z),
    new THREE.Vector3(max.x, max.y, min.z),
    new THREE.Vector3(max.x, max.y, max.z),
  ];

  const dirCamera = camera.getWorldDirection(new THREE.Vector3());

  let minDist = Infinity;
  let maxDist = -Infinity;
  points.forEach(function (p) {
    const pointDir = p.clone().sub(camera.position);
    const cos = pointDir.dot(dirCamera) / pointDir.length(); // Dircamera length is 1
    const dist = p.distanceTo(camera.position) * cos;
    if (minDist > dist) minDist = dist;
    if (maxDist &lt; dist) maxDist = dist;
  });

  const epsilon = 10;
  camera.near = Math.max(minDist - epsilon, 0.000001);
  camera.far = maxDist + epsilon;

  camera.updateProjectionMatrix();
}

/**
 * Move camera transform so the rectangle define by min &amp; max (in the xy plane) fit the entire screen
 *
 * @param {THREE.PerspectiveCamera} camera - camera to update
 * @param {THREE.Vector2} min - min coord of the rectangle
 * @param {THREE.Vector2} max - max coord of the rectangle
 * @param {number} altitude - altitude of the rectangle
 * @todo rectangle is not force to be in xy plane
 */
export function cameraFitRectangle(camera, min, max, altitude = 0) {
  const center = min.clone().lerp(max, 0.5);
  const width = max.x - min.x;
  const height = max.y - min.y;
  const fov = camera.fov * (Math.PI / 180); // fov radian
  const fovh = 2 * Math.atan(Math.tan(fov / 2) * camera.aspect);
  const dx = Math.abs(height / 2 / Math.tan(fovh / 2));
  const dy = Math.abs(width / 2 / Math.tan(fov / 2));
  const distance = Math.max(dx, dy);

  camera.position.copy(center);
  camera.position.z = distance + altitude;
  camera.rotation.set(0, 0, -Math.PI / 2);
  camera.updateProjectionMatrix();
}
/**
 * Traverse a THREE.Object3D and append in each Object3D children a THREE.LineSegment geometry  representing its wireframe
 *
 * @param {THREE.Object3D} object3D  An Object3D from three
 * @param {number} threshOldAngle  An edge is only rendered if the angle (in degrees) between the face normals of the adjoining faces exceeds this value. default = 1 degree.
 */
export function appendWireframeToObject3D(object3D, threshOldAngle = 30) {
  object3D.traverse((child) => {
    if (
      child.geometry &amp;&amp;
      child.geometry.isBufferGeometry &amp;&amp;
      !child.userData.isWireframe &amp;&amp;
      !child.userData.hasWireframe
    ) {
      // This bool avoid to create multiple wireframes for one geometry
      child.userData.hasWireframe = true;

      // THREE.EdgesGeometry needs triangle indices to be created.
      // Create a new array for the indices
      const indices = [];

      // Iterate over every group of three vertices in the unindexed mesh and add the corresponding indices to the indices array
      for (let i = 0; i &lt; child.geometry.attributes.position.count; i += 3) {
        indices.push(i, i + 1, i + 2);
      }
      child.geometry.setIndex(indices);

      // Create wireframes
      const geomEdges = new THREE.EdgesGeometry(child.geometry, threshOldAngle);
      const mat = new THREE.LineBasicMaterial({
        color: 0x000000,
      });
      const wireframe = new THREE.LineSegments(geomEdges, mat);
      wireframe.userData.isWireframe = true;
      child.add(wireframe);
      wireframe.updateWorldMatrix(true, false);
    }
  });
}

/**
 * Traverse a THREE.Object3D and append in each Object3D children a THREE.LineSegment geometry  representing its wireframe.
 * Each wireframe geometry will keep the associated attribute value.
 *
 * @param {THREE.Object3D} object3D  An Object3D from three
 * @param {string} nameOfGeometryAttribute The attribute used to split each geometry of the BufferGeometry
 * @param {number} threshOldAngle  An edge is only rendered if the angle (in degrees) between the face normals of the adjoining faces exceeds this value. default = 1 degree.
 */
export function appendWireframeByGeometryAttributeToObject3D(
  object3D,
  nameOfGeometryAttribute,
  threshOldAngle = 30
) {
  object3D.traverse((child) => {
    if (
      child.geometry &amp;&amp;
      child.geometry.isBufferGeometry &amp;&amp;
      !child.userData.isWireframe &amp;&amp;
      !child.userData.hasWireframe
    ) {
      // This event can be triggered multiple times, even when the geometry is loaded.
      // This bool avoid to create multiple wireframes for one geometry
      child.userData.hasWireframe = true;

      // Get the geometry that have the same value in the geometric attribute to create its own wireframe
      let startIndex = 0;

      // Position array that will be filled with each geometry
      const pos = new Array();

      // Array that will be filled with the geometric attribute
      const attributeArray = new Array();

      // Iterate through each geometry
      for (
        let i = 1;
        i &lt; child.geometry.attributes[nameOfGeometryAttribute].count;
        i++
      ) {
        if (
          child.geometry.attributes[nameOfGeometryAttribute].array[i - 1] !=
          child.geometry.attributes[nameOfGeometryAttribute].array[i]
        ) {
          const positionByAttribute = new THREE.BufferAttribute(
            child.geometry.attributes.position.array.slice(startIndex, i * 3),
            3
          );

          // Get all points that have the same value of the "nameOfGeometryAttribute"
          const mesh = new THREE.BufferGeometry();
          mesh.setAttribute('position', positionByAttribute);

          // THREE.EdgesGeometry needs triangle indices to be created.
          // Create a new array for the indices
          const indices = [];

          // Iterate over every group of three vertices in the unindexed mesh and add the corresponding indices to the indices array
          for (let j = 0; j &lt; mesh.attributes.position.count; j += 3) {
            indices.push(j, j + 1, j + 2);
          }
          mesh.setIndex(indices);

          // Create the wireframe geometry
          const edges = new THREE.EdgesGeometry(mesh, threshOldAngle);

          // Add this wireframe geometry to the global wireframe geometry
          for (let l = 0; l &lt; edges.attributes.position.count * 3; l++)
            pos.push(edges.attributes.position.array[l]);
          // Fill the attribute buffer
          for (let l = 0; l &lt; edges.attributes.position.count; l++)
            attributeArray.push(
              child.geometry.attributes[nameOfGeometryAttribute].array[i - 1]
            );

          startIndex = i * 3;
        }
      }

      const mat = new THREE.LineBasicMaterial({ color: 0x000000 });
      const geomEdges = new THREE.EdgesGeometry();
      geomEdges.setAttribute(
        'position',
        new THREE.BufferAttribute(Float32Array.from(pos), 3)
      );
      const wireframe = new THREE.LineSegments(geomEdges, mat);
      wireframe.geometry.setAttribute(
        nameOfGeometryAttribute,
        new THREE.BufferAttribute(Int32Array.from(attributeArray), 1)
      );
      wireframe.userData.isWireframe = true;
      child.add(wireframe);
      wireframe.updateWorldMatrix(true, false);
    }
  });
}

/**
 *
 * @typedef {object} SpriteStringOptions
 * @property {number} baseHeight height of the canvas and the the font size
 * @property {number} baseWidth width of the canvas
 * @property {number} borderSize border size of the canvas
 * @property {string} font string of font description css style-like
 */

/**
 * Generates a sprite with text from a given string
 *
 * @param {string} string The string displayed in the sprite
 * @param {SpriteStringOptions} [options] Options of generation
 * @returns {THREE.Sprite} three's Sprite
 */
export function createSpriteFromString(string, options = {}) {
  const baseHeight = options.baseHeight || 64;
  const baseWidth = options.baseWidth || 150;
  const borderSize = !!options.borderSize || 2;
  const ctx = document.createElement('canvas').getContext('2d');
  const font = options.font || `${baseHeight}px bold sans-serif`;
  ctx.font = font;
  // measure how long the name will be
  const textWidth = ctx.measureText(string).width;

  const doubleBorderSize = borderSize * 2;
  const width = baseWidth + doubleBorderSize;
  const height = baseHeight + doubleBorderSize;
  ctx.canvas.width = width;
  ctx.canvas.height = height;

  // need to set font again after resizing canvas
  ctx.font = font;
  ctx.textBaseline = 'middle';
  ctx.textAlign = 'center';

  ctx.fillStyle = 'black';
  ctx.fillRect(0, 0, width, height);

  // scale to fit but don't stretch
  const scaleFactor = Math.min(1, baseWidth / textWidth);
  ctx.translate(width / 2, height / 2);
  ctx.scale(scaleFactor, 1);
  ctx.fillStyle = 'white';
  ctx.fillText(string, 0, 0);

  const canvasTexture = new THREE.CanvasTexture(ctx.canvas);
  // canvasTexture.magFilter = THREE.NearestFilter;
  const label = new THREE.Sprite(
    new THREE.SpriteMaterial({ map: canvasTexture })
  );
  label.material.sizeAttenuation = false;
  return label;
}
</code></pre></article></section><footer class="footer" id="PeOAagUepe"><div class="wrapper">Fork: <a href="https://github.com/VCityTeam/UD-Viz">https://github.com/VCityTeam/UD-Viz</a></div></footer></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/utils_browser</a><div class="mobile-nav-links"><div class="navbar-item"><a id="Github-mobile" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples-mobile" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome-mobile" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udviz/extensions_3d_tiles_temporal-mobile" href="../extensions_3d_tiles_temporal" target="">udviz/extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/frame3d-mobile" href="../frame3d" target="">udviz/frame3d</a></div><div class="navbar-item"><a id="udviz/game_browser-mobile" href="../game_browser" target="">udviz/game_browser</a></div><div class="navbar-item"><a id="udviz/game_browser_template-mobile" href="../game_browser_template" target="">udviz/game_browser_template</a></div><div class="navbar-item"><a id="udviz/game_editor-mobile" href="../game_editor" target="">udviz/game_editor</a></div><div class="navbar-item"><a id="udviz/game_node-mobile" href="../game_node" target="">udviz/game_node</a></div><div class="navbar-item"><a id="udviz/game_node_template-mobile" href="../game_node_template" target="">udviz/game_node_template</a></div><div class="navbar-item"><a id="udviz/game_shared-mobile" href="../game_shared" target="">udviz/game_shared</a></div><div class="navbar-item"><a id="udviz/game_shared_template-mobile" href="../game_shared_template" target="">udviz/game_shared_template</a></div><div class="navbar-item"><a id="udviz/show_room-mobile" href="../show_room" target="">udviz/show_room</a></div><div class="navbar-item"><a id="udviz/smdb-mobile" href="../smdb" target="">udviz/smdb</a></div><div class="navbar-item"><a id="udviz/utils_browser-mobile" href="../utils_browser" target="">udviz/utils_browser</a></div><div class="navbar-item"><a id="udviz/utils_node-mobile" href="../utils_node" target="">udviz/utils_node</a></div><div class="navbar-item"><a id="udviz/utils_shared-mobile" href="../utils_shared" target="">udviz/utils_shared</a></div><div class="navbar-item"><a id="udviz/visualizer-mobile" href="../visualizer" target="">udviz/visualizer</a></div><div class="navbar-item"><a id="udviz/widget_3d_tiles-mobile" href="../widget_3d_tiles" target="">udviz/widget_3d_tiles</a></div><div class="navbar-item"><a id="udviz/widget_base_map-mobile" href="../widget_base_map" target="">udviz/widget_base_map</a></div><div class="navbar-item"><a id="udviz/widget_bookmark-mobile" href="../widget_bookmark" target="">udviz/widget_bookmark</a></div><div class="navbar-item"><a id="udviz/widget_camera_positioner-mobile" href="../widget_camera_positioner" target="">udviz/widget_camera_positioner</a></div><div class="navbar-item"><a id="udviz/widget_extensions_3d_tiles_temporal-mobile" href="../widget_extensions_3d_tiles_temporal" target="">udviz/widget_extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/widget_geocoding-mobile" href="../widget_geocoding" target="">udviz/widget_geocoding</a></div><div class="navbar-item"><a id="udviz/widget_guided_tour-mobile" href="../widget_guided_tour" target="">udviz/widget_guided_tour</a></div><div class="navbar-item"><a id="udviz/widget_layer_choice-mobile" href="../widget_layer_choice" target="">udviz/widget_layer_choice</a></div><div class="navbar-item"><a id="udviz/widget_legonizer-mobile" href="../widget_legonizer" target="">udviz/widget_legonizer</a></div><div class="navbar-item"><a id="udviz/widget_planar_controls-mobile" href="../widget_planar_controls" target="">udviz/widget_planar_controls</a></div><div class="navbar-item"><a id="udviz/widget_slide_show-mobile" href="../widget_slide_show" target="">udviz/widget_slide_show</a></div><div class="navbar-item"><a id="udviz/widget_sparql-mobile" href="../widget_sparql" target="">udviz/widget_sparql</a></div><div class="navbar-item"><a id="udviz/widget_versioning-mobile" href="../widget_versioning" target="">udviz/widget_versioning</a></div><div class="navbar-item"><a id="udviz/widget_workspace-mobile" href="../widget_workspace" target="">udviz/widget_workspace</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="RequestAnimationFrameProcess_RequestAnimationFrameProcess.html">RequestAnimationFrameProcess</a></div><div class="sidebar-section-children"><a href="Vector2Input.html">Vector2Input</a></div><div class="sidebar-section-children"><a href="Vector3Input.html">Vector3Input</a></div><div class="sidebar-section-children"><a href="Vector4Input.html">Vector4Input</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributing.html">Contributing</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Definitions.html">Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-ReleasePublish.html">ReleasePublish</a></div><div class="sidebar-section-children"><a href="tutorial-Reproducibility.html">Reproducibility</a></div><div class="sidebar-section-children"><a href="tutorial-architecture.html">architecture</a></div><div class="sidebar-section-children"><a href="tutorial-game.html">game</a></div><div class="sidebar-section-children"><a href="tutorial-how_to_import.html">how_to_import</a></div><div class="sidebar-section-children"><a href="tutorial-initial_camera_transform.html">initial_camera_transform</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#FileReaderCallback">FileReaderCallback</a></div><div class="sidebar-section-children"><a href="global.html#RequestService">RequestService</a></div><div class="sidebar-section-children"><a href="global.html#SceneConfig">SceneConfig</a></div><div class="sidebar-section-children"><a href="global.html#SpriteStringOptions">SpriteStringOptions</a></div><div class="sidebar-section-children"><a href="global.html#URLSetCameraMatrix">URLSetCameraMatrix</a></div><div class="sidebar-section-children"><a href="global.html#addCubeTexture">addCubeTexture</a></div><div class="sidebar-section-children"><a href="global.html#addLights">addLights</a></div><div class="sidebar-section-children"><a href="global.html#appendCameraMatrixToURL">appendCameraMatrixToURL</a></div><div class="sidebar-section-children"><a href="global.html#appendWireframeByGeometryAttributeToObject3D">appendWireframeByGeometryAttributeToObject3D</a></div><div class="sidebar-section-children"><a href="global.html#appendWireframeToObject3D">appendWireframeToObject3D</a></div><div class="sidebar-section-children"><a href="global.html#autoDurationTravel">autoDurationTravel</a></div><div class="sidebar-section-children"><a href="global.html#bindLightTransform">bindLightTransform</a></div><div class="sidebar-section-children"><a href="global.html#cameraFitRectangle">cameraFitRectangle</a></div><div class="sidebar-section-children"><a href="global.html#cbTickAnimationFrame">cbTickAnimationFrame</a></div><div class="sidebar-section-children"><a href="global.html#checkParentChild">checkParentChild</a></div><div class="sidebar-section-children"><a href="global.html#colorSpace">colorSpace</a></div><div class="sidebar-section-children"><a href="global.html#computeFileNameFromPath">computeFileNameFromPath</a></div><div class="sidebar-section-children"><a href="global.html#computeNearFarCamera">computeNearFarCamera</a></div><div class="sidebar-section-children"><a href="global.html#createDateIntervalInput">createDateIntervalInput</a></div><div class="sidebar-section-children"><a href="global.html#createDisplayable">createDisplayable</a></div><div class="sidebar-section-children"><a href="global.html#createLabelInput">createLabelInput</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageCheckbox">createLocalStorageCheckbox</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageDetails">createLocalStorageDetails</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageNumberInput">createLocalStorageNumberInput</a></div><div class="sidebar-section-children"><a href="global.html#createLocalStorageSlider">createLocalStorageSlider</a></div><div class="sidebar-section-children"><a href="global.html#createSpriteFromString">createSpriteFromString</a></div><div class="sidebar-section-children"><a href="global.html#defaultConfigScene">defaultConfigScene</a></div><div class="sidebar-section-children"><a href="global.html#downloadImageOnDisk">downloadImageOnDisk</a></div><div class="sidebar-section-children"><a href="global.html#downloadObjectAsJson">downloadObjectAsJson</a></div><div class="sidebar-section-children"><a href="global.html#fetchC3DTileFeatureWithNodeText">fetchC3DTileFeatureWithNodeText</a></div><div class="sidebar-section-children"><a href="global.html#focusC3DTilesLayer">focusC3DTilesLayer</a></div><div class="sidebar-section-children"><a href="global.html#focusCameraOn">focusCameraOn</a></div><div class="sidebar-section-children"><a href="global.html#getUriLocalname">getUriLocalname</a></div><div class="sidebar-section-children"><a href="global.html#getUriNamespace">getUriNamespace</a></div><div class="sidebar-section-children"><a href="global.html#initRenderer">initRenderer</a></div><div class="sidebar-section-children"><a href="global.html#initScene">initScene</a></div><div class="sidebar-section-children"><a href="global.html#loadJSON">loadJSON</a></div><div class="sidebar-section-children"><a href="global.html#loadMultipleJSON">loadMultipleJSON</a></div><div class="sidebar-section-children"><a href="global.html#loadTextFile">loadTextFile</a></div><div class="sidebar-section-children"><a href="global.html#localStorageSetMatrix4">localStorageSetMatrix4</a></div><div class="sidebar-section-children"><a href="global.html#localStorageSetVector3">localStorageSetVector3</a></div><div class="sidebar-section-children"><a href="global.html#readFileAsGltf">readFileAsGltf</a></div><div class="sidebar-section-children"><a href="global.html#readSingleFileAsDataUrl">readSingleFileAsDataUrl</a></div><div class="sidebar-section-children"><a href="global.html#readSingleFileAsText">readSingleFileAsText</a></div><div class="sidebar-section-children"><a href="global.html#tokenizeURI">tokenizeURI</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>