<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link type="text/css" rel="stylesheet" href="custom.css"><title>Source: Legonizer.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/widget_legonizer</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="LegoMockupVisualizer.html">LegoMockupVisualizer</a></div><div class="sidebar-section-children"><a href="Legonizer.html">Legonizer</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributing.html">Contributing</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Definitions.html">Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-ReleasePublish.html">ReleasePublish</a></div><div class="sidebar-section-children"><a href="tutorial-Reproducibility.html">Reproducibility</a></div><div class="sidebar-section-children"><a href="tutorial-architecture.html">architecture</a></div><div class="sidebar-section-children"><a href="tutorial-game.html">game</a></div><div class="sidebar-section-children"><a href="tutorial-how_to_import.html">how_to_import</a></div><div class="sidebar-section-children"><a href="tutorial-initial_camera_transform.html">initial_camera_transform</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#createMockUpObject">createMockUpObject</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="Github" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udviz/extensions_3d_tiles_temporal" href="../extensions_3d_tiles_temporal" target="">udviz/extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/frame3d" href="../frame3d" target="">udviz/frame3d</a></div><div class="navbar-item"><a id="udviz/game_browser" href="../game_browser" target="">udviz/game_browser</a></div><div class="navbar-item"><a id="udviz/game_browser_template" href="../game_browser_template" target="">udviz/game_browser_template</a></div><div class="navbar-item"><a id="udviz/game_editor" href="../game_editor" target="">udviz/game_editor</a></div><div class="navbar-item"><a id="udviz/game_node" href="../game_node" target="">udviz/game_node</a></div><div class="navbar-item"><a id="udviz/game_node_template" href="../game_node_template" target="">udviz/game_node_template</a></div><div class="navbar-item"><a id="udviz/game_shared" href="../game_shared" target="">udviz/game_shared</a></div><div class="navbar-item"><a id="udviz/game_shared_template" href="../game_shared_template" target="">udviz/game_shared_template</a></div><div class="navbar-item"><a id="udviz/show_room" href="../show_room" target="">udviz/show_room</a></div><div class="navbar-item"><a id="udviz/smdb" href="../smdb" target="">udviz/smdb</a></div><div class="navbar-item"><a id="udviz/utils_browser" href="../utils_browser" target="">udviz/utils_browser</a></div><div class="navbar-item"><a id="udviz/utils_node" href="../utils_node" target="">udviz/utils_node</a></div><div class="navbar-item"><a id="udviz/utils_shared" href="../utils_shared" target="">udviz/utils_shared</a></div><div class="navbar-item"><a id="udviz/visualizer" href="../visualizer" target="">udviz/visualizer</a></div><div class="navbar-item"><a id="udviz/widget_3d_tiles" href="../widget_3d_tiles" target="">udviz/widget_3d_tiles</a></div><div class="navbar-item"><a id="udviz/widget_base_map" href="../widget_base_map" target="">udviz/widget_base_map</a></div><div class="navbar-item"><a id="udviz/widget_bookmark" href="../widget_bookmark" target="">udviz/widget_bookmark</a></div><div class="navbar-item"><a id="udviz/widget_camera_positioner" href="../widget_camera_positioner" target="">udviz/widget_camera_positioner</a></div><div class="navbar-item"><a id="udviz/widget_extensions_3d_tiles_temporal" href="../widget_extensions_3d_tiles_temporal" target="">udviz/widget_extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/widget_geocoding" href="../widget_geocoding" target="">udviz/widget_geocoding</a></div><div class="navbar-item"><a id="udviz/widget_guided_tour" href="../widget_guided_tour" target="">udviz/widget_guided_tour</a></div><div class="navbar-item"><a id="udviz/widget_layer_choice" href="../widget_layer_choice" target="">udviz/widget_layer_choice</a></div><div class="navbar-item"><a id="udviz/widget_legonizer" href="../widget_legonizer" target="">udviz/widget_legonizer</a></div><div class="navbar-item"><a id="udviz/widget_planar_controls" href="../widget_planar_controls" target="">udviz/widget_planar_controls</a></div><div class="navbar-item"><a id="udviz/widget_slide_show" href="../widget_slide_show" target="">udviz/widget_slide_show</a></div><div class="navbar-item"><a id="udviz/widget_sparql" href="../widget_sparql" target="">udviz/widget_sparql</a></div><div class="navbar-item"><a id="udviz/widget_versioning" href="../widget_versioning" target="">udviz/widget_versioning</a></div><div class="navbar-item"><a id="udviz/widget_workspace" href="../widget_workspace" target="">udviz/widget_workspace</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">Legonizer.js</h1></header><article><pre class="prettyprint source lang-js"><code>import {
  Vector2Input,
  Vector3Input,
  Vector4Input,
  createLabelInput,
  checkParentChild,
} from '@ud-viz/utils_browser';
import { PlanarView, MAIN_LOOP_EVENTS } from 'itowns';
import {
  BoxGeometry,
  Mesh,
  MeshLambertMaterial,
  Object3DEventMap,
  Vector2,
  Vector3,
  Vector4,
  MeshBasicMaterial,
} from 'three';
import { TransformControls } from 'three/examples/jsm/controls/TransformControls.js';
import { InputManager } from '@ud-viz/game_browser';
import { createMockUpObject } from './MockUpUtils';
import { LegoMockupVisualizer } from './LegoMockupVisualizer';
import {
  createHeightMapFromBufferGeometry,
  generateCSVwithHeightMap,
} from 'legonizer';

/**
 * Provides functionality for generating a Lego mockup based on user-defined coordinates and scales.
 */
export class Legonizer {
  /**
   * Init properties and sets up the DOM elements and scene for a planar view.
   *
   * @param {PlanarView} view Represents the 3D view or scene. Objects will be displayed and manipulated.
   * @param {{parentDomElement:HTMLElement,domMockUpVisualizer:HTMLElement}} [options] Optionals parameter. Represents the user interface element. If no `parentDomElement` parameter is provided, the
   * `domElement` of widget is used. If no `domMockUpVisualizer` a default one is created
   */
  constructor(view, options = {}) {
    /** @type {HTMLElement} */
    this.domElement = null;
    /** @type {HTMLElement} */
    this.domMockUpVisualizer = options.domMockUpVisualizer || null;
    /** @type {HTMLElement} */
    this.parentDomElement = options.parentDomElement || this.domElement;
    /** @type {Vector3Input} */
    this.positionVec3Input = null;
    /** @type {Vector3Input} */
    this.rotationVec3Input = null;
    /** @type {Vector3Input} */
    this.scaleVec3Input = null;
    /** @type {Vector2Input} */
    this.countLegoVec2Input = null;
    /** @type {{parent:HTMLDivElement,input:HTMLInputElement,label:HTMLLabelElement}} */
    this.scaleParameterLabelInput = null;
    /** @type {{parent:HTMLDivElement,input:HTMLInputElement,label:HTMLLabelElement}} */
    this.legoHeightParameterLabelInput = null;
    /** @type {HTMLButtonElement} */
    this.buttonSelectionAreaElement = null;
    /** @type {HTMLButtonElement} */
    this.buttonGenerateCSVElement = null;
    /** @type {LegoMockupVisualizer} */
    this.legoMockupVisualizer = null;

    /** @type {PlanarView} */
    this.view = view;

    /** @type {Mesh&lt;BoxGeometry, MeshLambertMaterial, Object3DEventMap>} */
    this.boxSelector = null;
    /** @type {Mesh&lt;BoxGeometry, MeshLambertMaterial, Object3DEventMap>} */
    this.legoPrevisualisation = null;
    /** @type {TransformControls} */
    this.transformCtrls = null;

    /** @type {number} */
    this.scale = 3;

    /** @type {number} */
    this.legoHeight = 10;

    /** @type {any[]} */
    this.heightmap = null;

    this.inputManager = new InputManager();

    this.initDomElement();
    this.initScene();
    this.view.addFrameRequester(MAIN_LOOP_EVENTS.AFTER_CAMERA_UPDATE, () => {
      this._updateFieldsFromBoxSelector();
    });
  }

  /**
   * Creates, set `domElement` and returns a DOM element.
   *
   * @returns {HTMLDivElement} `legonizerDomElement` the newly `&lt;div>` element.
   */
  initDomElement() {
    const legonizerDomElement = document.createElement('div');
    legonizerDomElement.appendChild(this.createCoordinatesDomEl());
    legonizerDomElement.appendChild(this.createScaleDomEl());
    // Button Generate Lego Mockup
    const buttonGenerateMockupElement = document.createElement('button');
    buttonGenerateMockupElement.textContent = 'Generate Lego Mockup';
    buttonGenerateMockupElement.onclick = () => {
      this.generateMockup();
    };
    legonizerDomElement.appendChild(buttonGenerateMockupElement);

    this.domElement = legonizerDomElement;

    // button Generate CSV Mockup.
    this.buttonGenerateCSVElement = document.createElement('button');
    this.buttonGenerateCSVElement.textContent = 'Generate CSV Mockup';
    this.buttonGenerateCSVElement.onclick = () => {
      // Generate a CSV file with the heightmap.
      generateCSVwithHeightMap(
        this.heightmap,
        'legoPlates_' +
          this.countLegoVec2Input.x.input.step +
          '_' +
          this.countLegoVec2Input.y.input.step +
          '.csv'
      );
    };
    legonizerDomElement.appendChild(this.buttonGenerateCSVElement);
    this.buttonGenerateCSVElement.disabled = true;

    if (!this.domMockUpVisualizer) {
      const domMockUpVisualizer = document.createElement('div');
      domMockUpVisualizer.style.position = 'relative';
      domMockUpVisualizer.style.width = '100%';
      domMockUpVisualizer.style.aspectRatio = '16/9';
      domMockUpVisualizer.style.cursor = 'pointer';
      this.domMockUpVisualizer = domMockUpVisualizer;
    }
    this.domElement.appendChild(this.domMockUpVisualizer);
    return legonizerDomElement;
  }

  /**
   * Init the scene by creating a box selector, a Lego previsualization, and adding
   * transform controls to the scene.
   */
  initScene() {
    this.createBoxSelector();
    this.createLegoPrevisualisation();

    // Transform controls
    this.transformCtrls = new TransformControls(
      this.view.camera.camera3D,
      this.view.mainLoop.gfxEngine.label2dRenderer.domElement
    );

    // Update view when the box selector is changed
    this.transformCtrls.addEventListener('dragging-changed', (event) => {
      this.view.controls.enabled = !event.value;
    });
    this.transformCtrls.addEventListener('change', () => {
      this.transformCtrls.updateMatrixWorld();
      this.view.notifyChange();
    });
    this.view.scene.add(this.transformCtrls);
    this.view.scene.add(this.boxSelector);
    this.view.scene.add(this.legoPrevisualisation);
  }

  /**
   * Creates the DOMElement related to the coordinates.
   *
   * @returns {HTMLDivElement} DOM element that contains a set of input fields for position, rotation, and scale, as well as a button for selecting an area.
   */
  createCoordinatesDomEl() {
    // Coordinates Box DOM
    const coordinatesDomElement = document.createElement('div');

    const coordinatesTitle = document.createElement('h3');
    coordinatesTitle.innerText = 'Coordinates';
    coordinatesDomElement.appendChild(coordinatesTitle);

    this.positionVec3Input = new Vector3Input('Position', 1, 0);
    this.positionVec3Input.inputElements.forEach((input) => {
      input.addEventListener('change', (event) => {
        const value = event.target.value;
        if (value) {
          this.boxSelector.position.set(
            parseFloat(this.positionVec3Input.x.input.value),
            parseFloat(this.positionVec3Input.y.input.value),
            parseFloat(this.positionVec3Input.z.input.value)
          );
          this.boxSelector.updateMatrixWorld();
          this.transformCtrls.updateMatrixWorld();
          this.view.notifyChange();
        }
      });
    });
    coordinatesDomElement.appendChild(this.positionVec3Input);

    this.rotationVec3Input = new Vector3Input('Rotation', 1, 0);
    this.rotationVec3Input.inputElements.forEach((input) => {
      input.addEventListener('change', (event) => {
        const value = event.target.value;
        if (value) {
          this.boxSelector.rotation.set(
            parseFloat(this.rotationVec3Input.x.input.value),
            parseFloat(this.rotationVec3Input.y.input.value),
            parseFloat(this.rotationVec3Input.z.input.value)
          );
          this.boxSelector.updateMatrixWorld();
          this.transformCtrls.updateMatrixWorld();
          this.view.notifyChange();
        }
      });
    });
    coordinatesDomElement.appendChild(this.rotationVec3Input);

    this.scaleVec3Input = new Vector3Input('Scale', 1, 0);
    this.scaleVec3Input.inputElements.forEach((input) => {
      input.addEventListener('change', (event) => {
        const value = event.target.value;
        if (value) {
          this.boxSelector.scale.set(
            parseFloat(this.scaleVec3Input.x.input.value),
            parseFloat(this.scaleVec3Input.y.input.value),
            parseFloat(this.scaleVec3Input.z.input.value)
          );
          this.boxSelector.updateMatrixWorld();
          this.transformCtrls.updateMatrixWorld();
          this.view.notifyChange();
        }
      });
    });
    coordinatesDomElement.appendChild(this.scaleVec3Input);

    // Button Select an area
    this.buttonSelectionAreaElement = document.createElement('button');
    this.buttonSelectionAreaElement.textContent = 'Select an area';
    this.buttonSelectionAreaElement.onclick = () => {
      this.selectArea();
    };

    coordinatesDomElement.appendChild(this.buttonSelectionAreaElement);

    return coordinatesDomElement;
  }

  /**
   * Creates the DOMElement related to the scale.
   *
   * @returns {HTMLDivElement} DOM element of Scale Section. **Children:**
   *- **ratio**: This input number controls the accuracy of the heightmap.
   *- **countLego**: This vec2Input parameter specifies the number of plates to be used in the mockup.
   */
  createScaleDomEl() {
    // Scale Box DOM
    const scalesSectionDomElement = document.createElement('div');

    const scaleTitle = document.createElement('h3');
    scaleTitle.innerText = 'Scales Parameters';
    scalesSectionDomElement.appendChild(scaleTitle);

    this.scaleParameterLabelInput = createLabelInput('Scale', 'number');
    this.scaleParameterLabelInput.input.value = 0;
    this.scaleParameterLabelInput.input.addEventListener('change', (event) => {
      const value = event.target.value;
      if (value) {
        this.scale = this.scaleParameterLabelInput.input.value;
        this.boxSelector.updateMatrixWorld();
        this.transformCtrls.updateMatrixWorld();
        this.view.notifyChange();
      }
    });

    scalesSectionDomElement.appendChild(this.scaleParameterLabelInput.parent);

    this.legoHeightParameterLabelInput = createLabelInput(
      'Lego Max height',
      'number'
    );
    this.legoHeightParameterLabelInput.input.value = 10;
    this.legoHeightParameterLabelInput.input.addEventListener(
      'change',
      (event) => {
        const value = event.target.value;
        if (value) {
          this.legoHeight = this.legoHeightParameterLabelInput.input.value;
        }
      }
    );

    scalesSectionDomElement.appendChild(
      this.legoHeightParameterLabelInput.parent
    );

    this.countLegoVec2Input = new Vector2Input('Count Lego', 1, 0);

    this.countLegoVec2Input.x.input.addEventListener('change', (event) => {
      const xValue = event.target.value;
      this.boxSelector.scale.x = xValue * this.scale * 32;
      this.boxSelector.updateMatrixWorld();
      this.transformCtrls.updateMatrixWorld();
      this.view.notifyChange();
    });

    this.countLegoVec2Input.y.input.addEventListener('change', (event) => {
      const yValue = event.target.value;
      this.boxSelector.scale.y = yValue * this.scale * 32;
      this.boxSelector.updateMatrixWorld();
      this.transformCtrls.updateMatrixWorld();
      this.view.notifyChange();
    });

    scalesSectionDomElement.appendChild(this.countLegoVec2Input);
    return scalesSectionDomElement;
  }

  /**
   * Creates a box selector mesh to be used for selecting tiles.
   *
   * @returns {Mesh} The box selector mesh.
   */
  createBoxSelector() {
    // create a unit cube geometry.
    const geometry = new BoxGeometry(1, 1, 1);

    const boxSelector = new Mesh(
      geometry,
      new MeshLambertMaterial({
        color: 0x00ff00,
        opacity: 0.3,
        transparent: true,
      })
    );

    // position the box selector at the center of the tile layer.
    boxSelector.position.x = this.view.tileLayer.extent.center().x;
    boxSelector.position.y = this.view.tileLayer.extent.center().y;
    boxSelector.position.z = 200;

    boxSelector.updateMatrixWorld();

    this.boxSelector = boxSelector;
    return boxSelector;
  }

  /**
   * Creates a Lego previsualization mesh to be used for visualizing the selected area.
   *
   * @returns {Mesh} The Lego previsualization mesh.
   */
  createLegoPrevisualisation() {
    // calculate the dimensions of the Lego previsualization based on the ratio.
    const geometryLego = new BoxGeometry(
      this.scale,
      this.scale,
      (this.scale * 9.6) / 7.8 // Lego dimension
    );

    const objectLego = new Mesh(
      geometryLego,
      new MeshLambertMaterial({
        color: 0x00ff00,
      })
    );

    // position the Lego previsualization at the same position as the box selector.
    objectLego.position.x = this.boxSelector.position.x;
    objectLego.position.y = this.boxSelector.position.y;
    objectLego.position.z = 300;

    objectLego.updateMatrixWorld();

    this.legoPrevisualisation = objectLego;
    return objectLego;
  }

  /**
   * Updates the form fields from the box selector position.
   *
   * @private
   */
  _updateFieldsFromBoxSelector() {
    /**
     * Sets the values of input fields in a vector input
     *
     * @param {Vector2Input | Vector3Input | Vector4Input} vecInput - Contains input fields for each component of a vector.
     * @param {Vector2 | Vector3| Vector4} vector - A vector from three.
     */
    const setVecInputFromVector = (vecInput, vector) => {
      vecInput.x.input.value = vector.x;
      vecInput.y.input.value = vector.y;
      if (vecInput.z) vecInput.z.input.value = vector.z;
      if (vecInput.w) vecInput.w.input.value = vector.w;
    };

    setVecInputFromVector(this.positionVec3Input, this.boxSelector.position);
    setVecInputFromVector(this.rotationVec3Input, this.boxSelector.rotation);
    setVecInputFromVector(this.scaleVec3Input, this.boxSelector.scale);
    setVecInputFromVector(
      this.countLegoVec2Input,
      new Vector2(
        Math.trunc(this.boxSelector.scale.x / this.scale / 32),
        Math.trunc(this.boxSelector.scale.y / this.scale / 32)
      )
    );

    this.scaleParameterLabelInput.input.value = this.scale;
  }

  /**
   * Generates a mockup of the selected area using the specified number of Lego plates.
   */
  generateMockup() {
    const bufferBoxGeometry = this.boxSelector.geometry.clone();
    bufferBoxGeometry.applyMatrix4(this.boxSelector.matrixWorld);

    bufferBoxGeometry.computeBoundingBox();

    // Get the number of plates in the x and y directions.
    const xPlates = parseInt(this.countLegoVec2Input.x.input.value);
    const yPlates = parseInt(this.countLegoVec2Input.y.input.value);

    // Get the C3DTiles layers from the view.
    const layers = this.view.getLayers().filter((el) => el.isC3DTilesLayer);

    const mockUpObject = createMockUpObject(
      layers,
      bufferBoxGeometry.boundingBox
    );

    if (!mockUpObject || !mockUpObject.geometry) return;

    // Create a heightmap from the buffer geometry.
    const heightmap = createHeightMapFromBufferGeometry(
      mockUpObject.geometry,
      bufferBoxGeometry.boundingBox,
      xPlates,
      yPlates,
      this.legoHeight
    );

    // Create a Lego mockup visualizer and add the Lego plate simulation.
    if (this.legoMockupVisualizer) {
      this.legoMockupVisualizer.dispose();
      this.buttonGenerateCSVElement.disabled = true;
    }

    this.legoMockupVisualizer = new LegoMockupVisualizer(
      this.domMockUpVisualizer
    );
    this.legoMockupVisualizer.addLegoPlateSimulation(heightmap);
    this.legoMockupVisualizer.generateCadastre(heightmap);

    this.heightmap = heightmap;
    this.buttonGenerateCSVElement.disabled = false;
  }

  /**
   * Toggle the selection area for a Lego model. When is enabled, you can drag the mouse to define a rectangular area in the 3D view.
   */
  selectArea() {
    this.view.controls.enabled = !this.view.controls.enabled;

    if (this.view.controls.enabled) {
      this.buttonSelectionAreaElement.textContent = 'Select an area';
      this.inputManager.setPointerLock(false);

      this.inputManager.dispose();

      this.transformCtrls.visible = true;
      this.transformCtrls.attach(this.boxSelector);
      this.transformCtrls.updateMatrixWorld();
    } else {
      this.buttonSelectionAreaElement.textContent = 'Finish';

      this.transformCtrls.detach(this.boxSelector);
      this.transformCtrls.visible = false;

      let isDragging = false;

      const geometry = new BoxGeometry(1, 1, 1);
      const material = new MeshBasicMaterial({
        color: 0x0000ff,
        opacity: 0.5,
        transparent: true,
        alphaTest: 0.5,
      });
      const selectAreaObject = new Mesh(geometry, material);

      selectAreaObject.name = 'Select Area Menu Object';

      // Compute z + height of the box
      let minZ, maxZ;

      const mouseCoordToWorldCoord = (event, result) => {
        this.view.getPickingPositionFromDepth(
          new Vector2(event.offsetX, event.offsetY),
          result
        );

        // Compute minZ maxZ according where the mouse is moving TODO check with a step in all over the rect maybe
        minZ = Math.min(minZ, result.z);
        maxZ = Math.max(maxZ, result.z);
        selectAreaObject.position.z = (minZ + maxZ) * 0.5;
        selectAreaObject.scale.z = 50 + maxZ - minZ; // 50 higher to see it
        selectAreaObject.updateMatrixWorld();
        this.view.notifyChange();
      };

      const worldCoordStart = new Vector3();
      const worldCoordCurrent = new Vector3();
      const center = new Vector3();

      const updateSelectAreaObject = () => {
        center.lerpVectors(worldCoordStart, worldCoordCurrent, 0.5);

        // Place on the x y plane
        selectAreaObject.position.x = center.x;
        selectAreaObject.position.y = center.y;

        // Compute scale
        selectAreaObject.scale.x = worldCoordCurrent.x - worldCoordStart.x;
        selectAreaObject.scale.y = worldCoordCurrent.y - worldCoordStart.y;
      };

      const dragStart = (event) => {
        if (checkParentChild(event.target, this.parentDomElement)) return; // Ui has been clicked

        isDragging = true; // Reset
        minZ = Infinity; // Reset
        maxZ = -Infinity; // Reset

        mouseCoordToWorldCoord(event, worldCoordStart);
        mouseCoordToWorldCoord(event, worldCoordCurrent);

        updateSelectAreaObject();

        this.view.scene.add(selectAreaObject);
      };
      this.inputManager.addMouseInput(
        this.view.domElement,
        'mousedown',
        dragStart
      );

      const dragging = (event) => {
        if (
          checkParentChild(event.target, this.parentDomElement) ||
          !isDragging
        )
          return; // Ui

        mouseCoordToWorldCoord(event, worldCoordCurrent);
        updateSelectAreaObject();
      };
      this.inputManager.addMouseInput(
        this.view.domElement,
        'mousemove',
        dragging
      );

      const dragEnd = () => {
        if (!isDragging) return; // Was not dragging

        this.view.scene.remove(selectAreaObject);
        isDragging = false;

        if (worldCoordStart.equals(worldCoordCurrent)) return; // It is not an area

        this.boxSelector.position.x = selectAreaObject.position.x;
        this.boxSelector.position.y = selectAreaObject.position.y;
        this.boxSelector.position.z = selectAreaObject.position.z;

        // Update scales with the size of a lego plates and the ratio chosen
        const nbPlatesX = Math.abs(
          Math.trunc(selectAreaObject.scale.x / this.scale / 32)
        );

        const nbPlatesY = Math.abs(
          Math.trunc(selectAreaObject.scale.y / this.scale / 32)
        );
        this.boxSelector.scale.x = nbPlatesX * this.scale * 32;
        this.boxSelector.scale.y = nbPlatesY * this.scale * 32;
        this.boxSelector.scale.z = Math.trunc(selectAreaObject.scale.z);
        this.legoPrevisualisation.position.x = selectAreaObject.position.x;
        this.legoPrevisualisation.position.y = selectAreaObject.position.y;
        this.legoPrevisualisation.position.z = selectAreaObject.position.z + 50;
        selectAreaObject.updateMatrixWorld();
        this.boxSelector.updateMatrixWorld();
        this.legoPrevisualisation.updateMatrixWorld();
        this.view.notifyChange(this.view.camera.camera3D);
      };
      this.inputManager.addMouseInput(this.view.domElement, 'mouseup', dragEnd);
    }
  }
}
</code></pre></article></section><footer class="footer" id="PeOAagUepe"><div class="wrapper">Fork: <a href="https://github.com/VCityTeam/UD-Viz">https://github.com/VCityTeam/UD-Viz</a></div></footer></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/widget_legonizer</a><div class="mobile-nav-links"><div class="navbar-item"><a id="Github-mobile" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples-mobile" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome-mobile" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udviz/extensions_3d_tiles_temporal-mobile" href="../extensions_3d_tiles_temporal" target="">udviz/extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/frame3d-mobile" href="../frame3d" target="">udviz/frame3d</a></div><div class="navbar-item"><a id="udviz/game_browser-mobile" href="../game_browser" target="">udviz/game_browser</a></div><div class="navbar-item"><a id="udviz/game_browser_template-mobile" href="../game_browser_template" target="">udviz/game_browser_template</a></div><div class="navbar-item"><a id="udviz/game_editor-mobile" href="../game_editor" target="">udviz/game_editor</a></div><div class="navbar-item"><a id="udviz/game_node-mobile" href="../game_node" target="">udviz/game_node</a></div><div class="navbar-item"><a id="udviz/game_node_template-mobile" href="../game_node_template" target="">udviz/game_node_template</a></div><div class="navbar-item"><a id="udviz/game_shared-mobile" href="../game_shared" target="">udviz/game_shared</a></div><div class="navbar-item"><a id="udviz/game_shared_template-mobile" href="../game_shared_template" target="">udviz/game_shared_template</a></div><div class="navbar-item"><a id="udviz/show_room-mobile" href="../show_room" target="">udviz/show_room</a></div><div class="navbar-item"><a id="udviz/smdb-mobile" href="../smdb" target="">udviz/smdb</a></div><div class="navbar-item"><a id="udviz/utils_browser-mobile" href="../utils_browser" target="">udviz/utils_browser</a></div><div class="navbar-item"><a id="udviz/utils_node-mobile" href="../utils_node" target="">udviz/utils_node</a></div><div class="navbar-item"><a id="udviz/utils_shared-mobile" href="../utils_shared" target="">udviz/utils_shared</a></div><div class="navbar-item"><a id="udviz/visualizer-mobile" href="../visualizer" target="">udviz/visualizer</a></div><div class="navbar-item"><a id="udviz/widget_3d_tiles-mobile" href="../widget_3d_tiles" target="">udviz/widget_3d_tiles</a></div><div class="navbar-item"><a id="udviz/widget_base_map-mobile" href="../widget_base_map" target="">udviz/widget_base_map</a></div><div class="navbar-item"><a id="udviz/widget_bookmark-mobile" href="../widget_bookmark" target="">udviz/widget_bookmark</a></div><div class="navbar-item"><a id="udviz/widget_camera_positioner-mobile" href="../widget_camera_positioner" target="">udviz/widget_camera_positioner</a></div><div class="navbar-item"><a id="udviz/widget_extensions_3d_tiles_temporal-mobile" href="../widget_extensions_3d_tiles_temporal" target="">udviz/widget_extensions_3d_tiles_temporal</a></div><div class="navbar-item"><a id="udviz/widget_geocoding-mobile" href="../widget_geocoding" target="">udviz/widget_geocoding</a></div><div class="navbar-item"><a id="udviz/widget_guided_tour-mobile" href="../widget_guided_tour" target="">udviz/widget_guided_tour</a></div><div class="navbar-item"><a id="udviz/widget_layer_choice-mobile" href="../widget_layer_choice" target="">udviz/widget_layer_choice</a></div><div class="navbar-item"><a id="udviz/widget_legonizer-mobile" href="../widget_legonizer" target="">udviz/widget_legonizer</a></div><div class="navbar-item"><a id="udviz/widget_planar_controls-mobile" href="../widget_planar_controls" target="">udviz/widget_planar_controls</a></div><div class="navbar-item"><a id="udviz/widget_slide_show-mobile" href="../widget_slide_show" target="">udviz/widget_slide_show</a></div><div class="navbar-item"><a id="udviz/widget_sparql-mobile" href="../widget_sparql" target="">udviz/widget_sparql</a></div><div class="navbar-item"><a id="udviz/widget_versioning-mobile" href="../widget_versioning" target="">udviz/widget_versioning</a></div><div class="navbar-item"><a id="udviz/widget_workspace-mobile" href="../widget_workspace" target="">udviz/widget_workspace</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="LegoMockupVisualizer.html">LegoMockupVisualizer</a></div><div class="sidebar-section-children"><a href="Legonizer.html">Legonizer</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributing.html">Contributing</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Definitions.html">Definitions</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-ReleasePublish.html">ReleasePublish</a></div><div class="sidebar-section-children"><a href="tutorial-Reproducibility.html">Reproducibility</a></div><div class="sidebar-section-children"><a href="tutorial-architecture.html">architecture</a></div><div class="sidebar-section-children"><a href="tutorial-game.html">game</a></div><div class="sidebar-section-children"><a href="tutorial-how_to_import.html">how_to_import</a></div><div class="sidebar-section-children"><a href="tutorial-initial_camera_transform.html">initial_camera_transform</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#createMockUpObject">createMockUpObject</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>